$(function(){"use strict";var r,n,o=$("#txt-keyword"),s=$("#table"),a=$("#ckb-copy"),e=$("#main-form"),i=new Map,d=["bilibili","优酷","爱奇艺","腾讯","第一弹","动画疯","acfun"],c=!0;function l(t){if(c&&0==t.indexOf("[弹幕包]")){c=!1;var o=$("#alert-container"),n=$("#about-danmu-pkg-content").html().trim();o.append(n)}}function u(o){n?p(o):$.get("data/list",function(t){n=Common.decrypt(t,r).split(","),p(o)})}function p(a){var o=n.length,e=0;n.forEach(function(n){if(i.has(n)){var t=i.get(n);f(a,n,t),b(++e,o)}else $.ajax({url:"https://cdn.jsdelivr.net/gh/"+n+"/index"}).done(function(t){var o=Common.decrypt(t,r).split(";").map(function(t,o){return t.split(",")});i.set(n,o),f(a,n,o)}).fail(function(t){toastr.error("请求弹幕仓库："+n+" 时，发生错误！"),console.error(t)}).always(function(){b(++e,o)})})}function b(t,o){t==o&&(s.bootstrapTable("hideLoading"),e.attr("disabled",!1))}function f(t,o,n){for(var a=[],e=n.length-1;0<=e;e--){var r=n[e],i=r[0];if(-1<i.toLowerCase().indexOf(t)){l(i);var c="https://cdn.jsdelivr.net/gh/"+o+"/"+r[3]+".7z";a.push({name:i,from:d[r[2]],length:r[1],operate:'<div class="btn-group"><button class="btn btn-success download">下载</button><button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split" data-toggle="dropdown"><span class="caret"></span></button><div class="dropdown-menu"><button class="dropdown-item btn download xl-download">迅雷下载</button></div></div>',url:c})}}0<a.length&&(s.bootstrapTable("append",a),s.bootstrapTable("hideLoading"))}Common.cookieIfPresent(ENUM_COOKIE_PATH.SEARCH,function(t){a.attr("checked",t.download_copy)}),a.change(function(){var t=$(this).is(":checked");Common.writeCookie(ENUM_COOKIE_PATH.SEARCH,{download_copy:t})}),$("#btn-search").click(function(){s.bootstrapTable("removeAll");var t=o.val().trim();0<t.length&&(e.attr("disabled",!0),s.bootstrapTable("showLoading"),function(o){r?u(o):$.get("data/key",function(t){r=CryptoJS.enc.Utf8.parse(t),u(o)})}(t.toLowerCase()))}),Common.fixTableHeight(s)}),window.operateEvents={"click .download":function(t,o,n,a){$("#ckb-copy").is(":checked")&&Common.clipboard(n.name,t);var e=$(t.target),r=n.url;e.hasClass("xl-download")&&(r="thunder://"+btoa("AA"+r+"ZZ")),Common.downloadFile(r)}};
